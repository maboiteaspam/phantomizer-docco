<!DOCTYPE html>

<html>
<head>
  <title>build.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>build.js</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="string">'use strict'</span>;

module.exports = <span class="keyword">function</span>(grunt) {

    <span class="keyword">var</span> fs = require(<span class="string">"fs"</span>);
    <span class="keyword">var</span> path = require(<span class="string">"path"</span>);
    <span class="keyword">var</span> childProcess = require(<span class="string">'child_process'</span>);

    grunt.registerTask(<span class="string">"phantomizer-docco"</span>, <span class="string">"Docco litteral documentation tool support for phantomizer"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span></pre></div>
        
      
        
        <p>this task is async, save async handler for later consumption</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> done = <span class="keyword">this</span>.async();</pre></div>
        
      
        
        <p>default options
src_pattern is a path array, <em>*/</em>.js will be appended to it</p>

        
          <div class='highlight'><pre>        var options = this.options({
            src_pattern:[],
            out_dir:'',
            layout:'linear'
        });

        var src_paths = options.src_pattern;
        var out_dir = options.out_dir;
        var output = out_dir.replace(/\\/g,"/");</pre></div>
        
      
        
        <p>ensure output directory exists</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span>( fs.existsSync(output) == <span class="literal">false</span> ){
            fs.mkdirSync(output);
        }</pre></div>
        
      
        
        <p>Array of batch for each directory, holds output, src_pattern and files found within</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> docco_runs = [];</pre></div>
        
      
        
        <p>current count of batch done</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> current_docco = <span class="number">0</span>;</pre></div>
        
      
        
        <p>iterate the sources paths</p>

        
          <div class='highlight'><pre>        <span class="keyword">for</span>( <span class="keyword">var</span> n <span class="keyword">in</span> src_paths ){
            <span class="keyword">var</span> src_path = path.normalize(src_paths[n]);</pre></div>
        
      
        
        <p>find all files to document</p>

        
          <div class='highlight'><pre>            <span class="keyword">var</span> files = grunt.file.expand({}, src_path+<span class="string">"**/*.js"</span>);
            <span class="keyword">if</span>( files.length == <span class="number">0</span> ){
                grunt.log.warn(<span class="string">"Did not find files in "</span>+src_path)
            }<span class="keyword">else</span>{</pre></div>
        
      
        
        <p>group them by diretory</p>

        
          <div class='highlight'><pre>                <span class="keyword">var</span> files_by_dir = grouped_by_directory(files);
                <span class="keyword">for</span>(<span class="keyword">var</span> dir <span class="keyword">in</span> files_by_dir ){
                    <span class="keyword">if</span>( files_by_dir[dir].length &gt; <span class="number">0</span> ){</pre></div>
        
      
        
        <p>create a new docco_run for later process</p>

        
          <div class='highlight'><pre>                        docco_runs.push({
                            out: path.normalize(output+dir.substr(src_path.length-<span class="number">1</span>)),
                            src_path: src_path,
                            files: files_by_dir[dir]
                        });
                    }
                }

            }
        }</pre></div>
        
      
        
        <p>process a batch of file to comment</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> run_docco = <span class="keyword">function</span>(){</pre></div>
        
      
        
        <p>if all tasks ended</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span>( current_docco &gt;= docco_runs.length ){</pre></div>
        
      
        
        <p>consume async handler</p>

        
          <div class='highlight'><pre>                done();
                <span class="keyword">return</span>;
            }</pre></div>
        
      
        
        <p>prepare execution of dooco as an external binary, helped to solve some difficulties</p>

        
          <div class='highlight'><pre>            <span class="keyword">var</span> docco_path = path.dirname(require.resolve(<span class="string">"docco"</span>))+<span class="string">"/bin/docco"</span>;
            <span class="keyword">var</span> docco_run = docco_runs[current_docco];
            <span class="keyword">var</span> args = [
                docco_path,
                <span class="string">"--verbose"</span>,
                <span class="string">"-l"</span>, options.layout,
                <span class="string">"-o"</span>, docco_run.out
            ];</pre></div>
        
      
        
        <p>for the current batch push files to docco bin&#39;s argv</p>

        
          <div class='highlight'><pre>            <span class="keyword">for</span>( <span class="keyword">var</span> f <span class="keyword">in</span> docco_run.files ){
                args.push(docco_run.files[f]);
            }</pre></div>
        
      
        
        <p>execute docco</p>

        
          <div class='highlight'><pre>            <span class="keyword">try</span>{
                childProcess.execFile(process.execPath, args, <span class="keyword">function</span>(err, stdout, stderr) {</pre></div>
        
      
        
        <p>provide some statistics</p>

        
          <div class='highlight'><pre>                    grunt.log.writeln(<span class="string">""</span>);
                    grunt.log.ok(<span class="string">"Directory "</span>+(current_docco+<span class="number">1</span>)+<span class="string">"/"</span>+docco_runs.length);</pre></div>
        
      
        
        <p>display error on output</p>

        
          <div class='highlight'><pre>                    <span class="keyword">if</span>( err ) grunt.log.error(err);
                    <span class="keyword">if</span>( stderr ) grunt.log.error(stderr);</pre></div>
        
      
        
        <p>parse output and clean it from too long file paths</p>

        
          <div class='highlight'><pre>                    stdout = treat_stdout(stdout,docco_run.src_path,docco_run.out)</pre></div>
        
      
        
        <p>display cleaned docco output</p>

        
          <div class='highlight'><pre>                    grunt.log.ok(stdout);</pre></div>
        
      
        
        <p>update current count of tasks done</p>

        
          <div class='highlight'><pre>                    current_docco++;</pre></div>
        
      
        
        <p>recall</p>

        
          <div class='highlight'><pre>                    run_docco();
                })
            }<span class="keyword">catch</span>(ex){</pre></div>
        
      
        
        <p>manage fatal error</p>

        
          <div class='highlight'><pre>                grunt.log.error(ex);
                done(<span class="literal">false</span>);
            }
        }
        run_docco();
    });

    <span class="comment">/**
     *
     * @param files
     * @returns {{}}
     */</span>
    <span class="function"><span class="keyword">function</span> <span class="title">grouped_by_directory</span><span class="params">( files )</span>{</span>
        <span class="keyword">var</span> retour = {};
        <span class="keyword">for</span>(<span class="keyword">var</span> n <span class="keyword">in</span> files ){
            <span class="keyword">var</span> f = files[n];
            <span class="keyword">var</span> d = path.dirname(f);
            <span class="keyword">if</span>( ! retour[d] ) retour[d] = [];
            retour[d].push(f);
        }
        <span class="keyword">return</span> retour;
    }

    <span class="comment">/**
     *
     * @param stdout
     * @param src_path
     * @param out_path
     * @returns {string}
     */</span>
    <span class="function"><span class="keyword">function</span> <span class="title">treat_stdout</span><span class="params">( stdout,src_path,out_path )</span>{</span>
        <span class="keyword">var</span> retour = [];
        stdout = stdout.split(<span class="string">"\n"</span>);
        <span class="keyword">for</span>( <span class="keyword">var</span> n <span class="keyword">in</span> stdout ){
            retour.push(stdout[n].replace(src_path,<span class="string">""</span>).replace(out_path,<span class="string">""</span>).replace(<span class="string">"docco: "</span>,<span class="string">""</span>))
        }
        <span class="keyword">return</span> retour.join(<span class="string">"\n"</span>);
    }

};</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
